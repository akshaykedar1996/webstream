import { describe, it } from "node:test";
import assert from "node:assert";
import { createLoggerSystem } from "./index.js";
const capture = () => {
    const capturedLogs = {
        trace: [],
        debug: [],
        info: [],
        warn: [],
        error: [],
    };
    const sink = (level, message) => capturedLogs[level].push(message);
    return { sink, capturedLogs };
};
const LOG_REGEX = /^\[([^\]]+)\](?:\(([^)]*)\))?:\s*(.*)$/;
const parseLog = (msg) => {
    const [, scope, tags, message] = msg?.match(LOG_REGEX) ?? [];
    return { scope, tags, message };
};
describe("logger", () => {
    it("exposes log level per scope", () => {
        const { sink } = capture();
        const loggerSystem = createLoggerSystem();
        loggerSystem.configureLoggers({
            default: { level: "info", sink },
            "coordinator": { level: "debug", sink },
            "network": { level: "error", sink },
        });
        const coordinatorLogger = loggerSystem.getLogger("coordinator");
        const networkLogger = loggerSystem.getLogger("network");
        const apiCallsLogger = loggerSystem.getLogger("api-calls");
        assert.equal(coordinatorLogger.getLogLevel(), "debug");
        assert.equal(networkLogger.getLogLevel(), "error");
        assert.equal(apiCallsLogger.getLogLevel(), "info");
    });
    it("checks if the message in in correct format", () => {
        const { sink, capturedLogs } = capture();
        const loggerSystem = createLoggerSystem();
        loggerSystem.configureLoggers({
            default: { level: "info", sink },
        });
        loggerSystem.getLogger("api-calls", { tags: ["v1", "v2"] }).info("Calling api");
        const msg = capturedLogs.info[0];
        const { scope, tags, message } = parseLog(msg);
        assert.equal(message, "Calling api");
        assert.equal(scope, "api-calls");
        assert.equal(tags, "v1,v2");
    });
    it("filters below default level (info)", () => {
        const { sink, capturedLogs } = capture();
        const loggerSystem = createLoggerSystem();
        loggerSystem.configureLoggers({
            default: { level: "info", sink },
            network: { level: "warn", sink },
            scope: { level: "error", sink },
        });
        loggerSystem.getLogger("scope").info("should not be logged");
        loggerSystem.getLogger("scope").error("should be logged");
        loggerSystem.getLogger("api-call").info("calling api");
        loggerSystem.getLogger("coordinator", { tags: ["v2"] }).info("coordinator test");
        loggerSystem.getLogger("network").warn("network call");
        assert.deepEqual(capturedLogs.error, ["[scope]: should be logged"]);
        assert.deepEqual(capturedLogs.info, [
            "[api-call]: calling api",
            "[coordinator](v2): coordinator test",
        ]);
        assert.deepEqual(capturedLogs.warn, ["[network]: network call"]);
    });
    it("isolates log levels between different logger systems", () => {
        const { sink } = capture();
        const loggerSystemFeeds = createLoggerSystem();
        loggerSystemFeeds.configureLoggers({
            "client": { level: "error", sink },
        });
        const loggerSystemVideo = createLoggerSystem();
        loggerSystemVideo.configureLoggers({
            "client": { level: "info", sink },
        });
        const loggerSystemChat = createLoggerSystem();
        loggerSystemChat.configureLoggers({
            "client": { level: "warn", sink },
        });
        assert.equal(loggerSystemFeeds.getLogger("client").getLogLevel(), "error");
        assert.equal(loggerSystemVideo.getLogger("client").getLogLevel(), "info");
        assert.equal(loggerSystemChat.getLogger("client").getLogLevel(), "warn");
    });
});
//# sourceMappingURL=index.test.js.map